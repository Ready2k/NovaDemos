<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Creator - Voice S2S</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'dark', flowchart: { curve: 'basis' } });
        window.mermaid = mermaid;
    </script>
    <link rel="stylesheet" href="index.css">
    <style>
        /* Override/Extend index.css for Editor specific needs */
        .workspace-sidebar {
            width: 450px;
            min-width: 350px;
            max-width: 50vw;
            resize: horizontal;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 0;
            /* Clear padding to let tabs/content fill */
            gap: 0;
            /* Handle gap internally */
        }

        /* Re-apply internal padding to content, not container, so scrollbars work right */
        .sidebar-content-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .workspace-main {
            padding: 0;
            /* custom padding for graph area */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .workspace-header {
            padding: 20px 30px;
            border-bottom: var(--glass-border);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .graph-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }

        /* Tabs adjustments for sidebar context */
        .tabs-nav.editor-tabs {
            margin: 0;
            border-radius: 0;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: var(--glass-border);
            padding: 0;
        }

        .editor-tab-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: #94a3b8;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .editor-tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .editor-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Section visibility */
        .editor-section {
            display: none;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .editor-section.active {
            display: flex;
        }

        .editor-toolbar {
            padding: 15px;
            border-bottom: var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-toolbar h3 {
            margin: 0;
            font-size: 0.9rem;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .list-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .list-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.2) 0%, transparent 100%);
            border-color: rgba(99, 102, 241, 0.4);
        }

        .editor-form {
            border-top: var(--glass-border);
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            max-height: 40%;
            overflow-y: auto;
        }

        /* Mermaid Overrides */
        .mermaid {
            display: flex;
            justify-content: center;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1e293b;
            margin: 5% auto;
            padding: 30px;
            border: var(--glass-border);
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e2e8f0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            font-family: 'Inter', sans-serif;
        }

        .modal-content h1 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #60a5fa;
        }

        .modal-content h2 {
            font-size: 1.4rem;
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            color: #a78bfa;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }

        .modal-content h3 {
            font-size: 1.1rem;
            margin-top: 1rem;
            color: #94a3b8;
        }

        .modal-content p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .modal-content ul,
        .modal-content ol {
            margin-left: 20px;
            margin-bottom: 1rem;
        }

        .modal-content li {
            margin-bottom: 0.5rem;
        }

        .modal-content code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            color: #fbbf24;
        }

        .modal-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .modal-content blockquote {
            border-left: 4px solid #60a5fa;
            padding-left: 15px;
            margin: 1rem 0;
            color: #94a3b8;
            font-style: italic;
            background: rgba(59, 130, 246, 0.1);
            padding: 10px;
            border-radius: 0 4px 4px 0;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="app-container">

        <!-- SIDEBAR: Editor Panel -->
        <div class="sidebar workspace-sidebar">
            <div class="sidebar-content-wrapper">
                <!-- Custom Tabs -->
                <div class="tabs-nav editor-tabs">
                    <div class="editor-tab-btn active" data-tab="nodes">Nodes</div>
                    <div class="editor-tab-btn" data-tab="edges">Connections</div>
                </div>

                <!-- NODES TAB -->
                <div id="tab-nodes" class="editor-section active">
                    <div class="mb-4">
                        <button id="add-node-btn" class="secondary-btn w-full justify-center py-2">+ Add Node</button>
                    </div>
                    <div id="nodes-list" class="list-container">
                        <!-- JS Injected -->
                    </div>
                    <!-- Node Form -->
                    <div id="node-editor" class="editor-form hidden">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-size: 0.8rem; font-weight: bold; color: var(--accent-color);">EDIT
                                NODE</span>
                            <button id="delete-node-btn" class="danger-btn"
                                style="padding: 2px 8px; font-size: 0.75rem;">Delete</button>
                        </div>
                        <div class="input-group">
                            <label>ID</label>
                            <input type="text" id="node-id" class="font-mono"
                                style="opacity: 1; border-color: var(--accent-color); background: rgba(0,0,0,0.5); color: white;">
                        </div>
                        <div class="input-group">
                            <label>Label</label>
                            <textarea id="node-label" rows="2"
                                style="background: rgba(0,0,0,0.5); color: white; border-color: var(--glass-border);"></textarea>
                        </div>
                        <div class="input-group">
                            <label>Type</label>
                            <select id="node-type">
                                <option value="process">‚èπ Process</option>
                                <option value="decision">‚óá Decision</option>
                                <option value="tool">‚öôÔ∏è Tool Call</option>
                                <option value="start">‚óã Start</option>
                                <option value="end">‚óè End</option>
                            </select>
                        </div>
                        <div id="node-tool-config" class="input-group hidden"
                            style="background: rgba(139, 92, 246, 0.1); padding: 10px; border-radius: 8px;">
                            <label style="color: #a78bfa;">Tool Name</label>
                            <input type="text" id="node-tool-name" placeholder="e.g. get_balance" class="font-mono"
                                style="background: rgba(0,0,0,0.5); color: white; border-color: var(--glass-border);">
                        </div>
                        <div id="node-outcome-config" class="input-group hidden"
                            style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px;">
                            <label style="color: #6ee7b7;">Outcome Code</label>
                            <input type="text" id="node-outcome" placeholder="e.g. RESOLVED" class="font-mono"
                                style="background: rgba(0,0,0,0.5); color: white; border-color: var(--glass-border);">
                        </div>
                    </div>
                </div>

                <!-- EDGES TAB -->
                <div id="tab-edges" class="editor-section">
                    <div class="mb-4">
                        <button id="add-edge-btn" class="secondary-btn w-full justify-center py-2">+ Add
                            Connection</button>
                    </div>
                    <div id="edges-list" class="list-container"></div>
                    <!-- Edge Form -->
                    <div id="edge-editor" class="editor-form hidden">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="font-size: 0.8rem; font-weight: bold; color: var(--accent-color);">EDIT
                                LINK</span>
                            <button id="delete-edge-btn" class="danger-btn"
                                style="padding: 2px 8px; font-size: 0.75rem;">Delete</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="input-group">
                                <label>From</label>
                                <select id="edge-from" style="font-size: 0.8rem;"></select>
                            </div>
                            <div class="input-group">
                                <label>To</label>
                                <select id="edge-to" style="font-size: 0.8rem;"></select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Label / Condition</label>
                            <input type="text" id="edge-label" placeholder="e.g. Yes"
                                style="background: rgba(0,0,0,0.5); color: white; border-color: var(--glass-border);">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT: Visualizer -->
        <div class="main-content workspace-main">
            <!-- Header (Inside Main Card) -->
            <div class="workspace-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="/" class="secondary-btn" style="padding: 8px 16px; font-size: 0.9rem;">
                        ‚Üê Back
                    </a>
                    <div>
                        <h1 style="font-size: 1.5rem; margin-bottom: .2rem;">Workflow Creator</h1>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color: #64748b; font-size: 0.9rem;">Editing Persona:</span>
                            <select id="persona-select"
                                style="padding: 4px 12px; font-size: 0.85rem; width: auto; background: rgba(0,0,0,0.3);">
                                <option value="loading">Loading...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="guide-btn" class="secondary-btn" style="border-color: #6366f1; color: #a5b4fc;">üìñ
                        Guide</button>
                    <button id="reset-btn" class="secondary-btn">Revert</button>
                    <button id="save-btn" class="primary-btn">üíæ Save Workflow</button>
                </div>
            </div>

            <!-- Graph Area -->
            <div class="graph-wrapper">
                <div
                    style="position: absolute; top: 20px; right: 20px; z-index: 10; display: flex; gap: 10px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 8px; border: var(--glass-border);">
                    <button id="zoom-out-btn"
                        style="background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 4px; padding: 4px 10px; font-size: 1rem; cursor: pointer; line-height: 1;">-</button>
                    <span id="zoom-display"
                        style="padding: 4px 8px; color: #cbd5e1; font-family: monospace; font-size: 0.9rem; display: flex; align-items: center;">100%</span>
                    <button id="zoom-in-btn"
                        style="background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 4px; padding: 4px 10px; font-size: 1rem; cursor: pointer; line-height: 1;">+</button>
                    <button id="preview-fit-btn"
                        style="background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 4px; padding: 4px 8px; font-size: 0.8rem; cursor: pointer;">Fit</button>
                </div>

                <div id="graph-container"
                    class="w-full h-full flex items-center justify-center overflow-hidden cursor-grab active:cursor-grabbing"
                    style="width: 100%; height: 100%;">
                    <div id="mermaid-graph" class="transition-transform duration-100 ease-out"
                        style="transform-origin: 0 0;"></div>
                </div>

                <!-- Toasts -->
                <div id="error-toast" class="toast error hidden" style="position: absolute; bottom: 20px; left: 20px;">
                </div>
                <div id="success-toast" class="toast success hidden"
                    style="position: absolute; bottom: 20px; left: 20px;">Saved Successfully!</div>

                <!-- Helper Modal -->
                <div id="guide-modal" class="modal">
                    <div class="modal-content">
                        <span class="close-modal">&times;</span>
                        <div id="guide-content">Loading guide...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let currentWorkflow = { nodes: [], edges: [] };
        let selectedNodeId = null;
        let selectedEdgeIndex = null;
        let currentZoom = 1;
        let panX = 0, panY = 0;

        document.addEventListener('DOMContentLoaded', () => {
            loadPersonas();
            setupPanZoom();
            setupEditors();
            setupTabs();

            document.getElementById('save-btn').addEventListener('click', saveWorkflow);
            document.getElementById('reset-btn').addEventListener('click', () => loadWorkflow(document.getElementById('persona-select').value));

            // Guide Modal Logic
            const modal = document.getElementById('guide-modal');
            const btn = document.getElementById('guide-btn');
            const span = document.getElementsByClassName('close-modal')[0];

            btn.onclick = async () => {
                modal.style.display = 'block';
                if (document.getElementById('guide-content').innerHTML === 'Loading guide...') {
                    try {
                        const res = await fetch('/workflow_guide.md');
                        if (!res.ok) throw new Error('Guide not found');
                        const text = await res.text();
                        // Simple Markdown Parser (Headers, Lists, Code, Blockquotes)
                        let html = text
                            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                            .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
                            .replace(/```([\s\S]*?)```/gim, '<pre><code>$1</code></pre>')
                            .replace(/`([^`]+)`/gim, '<code>$1</code>')
                            .replace(/^\s*-\s(.*$)/gim, '<ul><li>$1</li></ul>').replace(/<\/ul>\s*<ul>/gim, '') // Naive list fix
                            .replace(/\n/gim, '<br>');

                        document.getElementById('guide-content').innerHTML = html;
                    } catch (e) {
                        document.getElementById('guide-content').innerHTML = '<p style="color:red">Failed to load guide. Please verify server is running.</p>';
                    }
                }
            }
            span.onclick = () => modal.style.display = 'none';
            window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; }
        });

        function setupTabs() {
            document.querySelectorAll('.editor-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.editor-tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.editor-section').forEach(s => s.classList.remove('active'));
                    btn.classList.add('active');
                    const tabId = 'tab-' + btn.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // --- Loading Data ---
        async function loadPersonas() {
            try {
                const res = await fetch('/api/personas');
                const personas = await res.json();
                const select = document.getElementById('persona-select');
                select.innerHTML = '';
                personas.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name;
                    if (p.id === 'persona-banking_bot') opt.selected = true;
                    select.appendChild(opt);
                });
                select.addEventListener('change', (e) => loadWorkflow(e.target.value));
                if (personas.length > 0) loadWorkflow(select.value);
            } catch (e) {
                console.error(e);
            }
        }

        async function loadWorkflow(id) {
            try {
                const res = await fetch(`/api/workflow/${id}`);
                const data = await res.json();
                currentWorkflow = data;
                renderEditorLists();
                renderGraph();
            } catch (e) {
                showError("Failed to load workflow: " + e.message);
            }
        }

        async function saveWorkflow() {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>Saving...</span>';
            btn.disabled = true;

            try {
                const id = document.getElementById('persona-select').value;
                const res = await fetch(`/api/workflow/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentWorkflow)
                });

                if (!res.ok) throw new Error("Save failed");
                showSuccess();
            } catch (e) {
                showError(e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- Render Helpers ---
        async function renderGraph() {
            const container = document.getElementById('mermaid-graph');
            const def = generateMermaid(currentWorkflow);

            try {
                const { svg } = await window.mermaid.render('graphDiv', def);
                container.innerHTML = svg;
                document.getElementById('error-toast').classList.add('hidden');

                // Add interactions after render
                setupGraphInteractions();
            } catch (e) {
                showError("Preview Error: " + e.message);
            }
        }

        function setupGraphInteractions() {
            const graph = document.getElementById('mermaid-graph');

            // 1. Nodes
            const nodes = graph.querySelectorAll('.node');
            nodes.forEach(node => {
                node.style.cursor = 'pointer';
                node.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent drag/pan start if possible
                    const id = node.id.replace(/^flowchart-/, '').replace(/-[a-z0-9]+$/, ''); // Mermaid adds prefixes/suffixes
                    // Try to find the matching node ID from our workflow
                    // Mermaid IDs are sometimes messy. Let's try to map back.
                    // A safer way is using the `id` we set in mermaid code.
                    // In `generateMermaid`, we use `n.id`. Mermaid often keeps this as the ID attribute of the group or internal rect.
                    // Let's use the 'id' attribute of the group class 'node'.

                    // The element 'node' is a <g class="node .. " id="...">
                    // The ID usually matches what we passed if unique.
                    // But Mermaid 10 might prefix it.

                    // Fallback: Check text content or data attributes if we could inject them.
                    // Actually, let's reverse look up by exact ID match if possible or clean the string.

                    // Let's iterate our nodes and see if the DOM ID contains our Node ID
                    const matchedNode = currentWorkflow.nodes.find(n => node.id.includes(n.id));
                    if (matchedNode) {
                        selectNode(matchedNode.id);
                        zoomToElement(node);
                    }
                });
            });

            // 2. Edges
            // Mermaid renders edges as paths with class 'edgePath'. 
            // It allows adding click events if we define interactions in mermaid, but here we do post-processing.
            // Matching DOM edge to data edge is tricky because they aren't labeled with IDs by default.
            // Strategy: We can rely on index order IF mermaid preserves it.
            // Alternatively, click on 'edgeLabel' is easier to map if we adding IDs to labels.

            // 2. Edges
            // Mermaid renders edges as paths. Selector often depends on version/theme but '.edgePaths path' is standard.
            const edgePaths = graph.querySelectorAll('.edgePaths path');
            console.log(`[Interaction] Found ${edgePaths.length} edge paths`);

            edgePaths.forEach((path, index) => {
                path.style.cursor = 'pointer';
                // Optional: Make it easier to click by increasing stroke width on hover via JS or CSS class
                // path.classList.add('clickable-edge'); 

                path.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log(`[Interaction] Edge path ${index} clicked`);
                    if (index < currentWorkflow.edges.length) {
                        selectEdge(index);
                        zoomToElement(path);
                    }
                });
            });

            // Make labels clickable too
            const edgeLabels = graph.querySelectorAll('.edgeLabels .edgeLabel');
            edgeLabels.forEach((label, index) => {
                label.style.cursor = 'pointer';
                label.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (index < currentWorkflow.edges.length) {
                        selectEdge(index);
                        // For label, zoom to the label itself
                        zoomToElement(label);
                    }
                });
            });
        }

        function zoomToElement(element) {
            const container = document.getElementById('graph-container');
            const graph = document.getElementById('mermaid-graph');

            // 1. Calculate the element's center in "Unscaled Graph Coordinates"
            const graphRect = graph.getBoundingClientRect(); // Current transformed rect
            const elRect = element.getBoundingClientRect();   // Current element rect

            // Relative position in current visual pixels
            const relativeLeft = elRect.left - graphRect.left;
            const relativeTop = elRect.top - graphRect.top;

            // Unscaled coordinates (relative to graph origin 0,0)
            const graphX = (relativeLeft + elRect.width / 2) / currentZoom;
            const graphY = (relativeTop + elRect.height / 2) / currentZoom;

            // 2. Determine Target Zoom
            // If current zoom is small (<1.5), zoom in. Otherwise keep current to avoid jumping.
            // Or always zoom to at least 1.5?
            const targetZoom = Math.max(currentZoom, 1.5);

            // 3. Calculate New Pan to center the point (graphX, graphY) at center of container
            // formula: pan + (graphCoord * zoom) = centerCoord
            // => pan = centerCoord - (graphCoord * zoom)

            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            const newPanX = (containerWidth / 2) - (graphX * targetZoom);
            const newPanY = (containerHeight / 2) - (graphY * targetZoom);

            // Apply
            currentZoom = targetZoom;
            panX = newPanX;
            panY = newPanY;

            document.getElementById('zoom-display').textContent = Math.round(currentZoom * 100) + '%';
            updateTransform();

            // Visual Highlight (Optional, simplistic)
            // Removes focus ring from others
            // element.style.filter = "brightness(1.5)"; 
            // setTimeout(() => element.style.filter = "", 1000);
        }

        function generateMermaid(data) {
            let def = 'flowchart TD\n';
            data.nodes.forEach(n => {
                const label = (n.label || n.id).replace(/"/g, "'").replace(/\n/g, '<br>');
                let s = '[', e = ']', style = '';

                if (n.type === 'start' || n.type === 'end') { s = '(['; e = '])'; style = 'fill:#1f2937,stroke:#3b82f6,color:#fff'; }
                else if (n.type === 'decision') { s = '{'; e = '}'; style = 'fill:#374151,stroke:#f59e0b,color:#fff'; }
                else if (n.type === 'tool') { s = '[['; e = ']]'; style = 'fill:#111827,stroke:#8b5cf6,color:#fff'; }
                else { style = 'fill:#1f2937,stroke:#4b5563,color:#9ca3af'; }

                def += `    ${n.id}${s}"${label}"${e}\n`;
                def += `    style ${n.id} ${style}\n`;
            });
            data.edges.forEach(edge => {
                const label = edge.label ? `|"${edge.label.replace(/"/g, "'")}"|` : '';
                def += `    ${edge.from} -->${label} ${edge.to}\n`;
            });
            return def;
        }

        function renderEditorLists() {
            console.log(`[Editor] Rendering lists. Nodes: ${currentWorkflow.nodes.length}, Edges: ${currentWorkflow.edges.length}`);

            // Render Nodes
            const nodesList = document.getElementById('nodes-list');
            nodesList.innerHTML = '';
            currentWorkflow.nodes.forEach(node => {
                const el = document.createElement('div');
                el.className = `list-item ${selectedNodeId === node.id ? 'active' : ''}`;
                el.innerHTML = `<div style="font-weight: 700; color: #e2e8f0; font-size: 0.9rem;">${node.id}</div><div style="font-size: 0.8rem; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${node.label}</div>`;
                el.onclick = () => selectNode(node.id);
                nodesList.appendChild(el);
            });

            // Render Edges
            const edgesList = document.getElementById('edges-list');
            edgesList.innerHTML = '';
            currentWorkflow.edges.forEach((edge, idx) => {
                const el = document.createElement('div');
                el.className = `list-item ${selectedEdgeIndex === idx ? 'active' : ''}`;
                el.innerHTML = `<div style="font-size: 0.8rem; color: #cbd5e1;">${edge.from} ‚Üí ${edge.to}</div><div style="font-size: 0.75rem; color: var(--accent-color);">${edge.label || '(no label)'}</div>`;
                el.onclick = () => selectEdge(idx);
                edgesList.appendChild(el);
            });

            // Populate Edge Dropdowns (Only if different to prevent value reset)
            const nodeOptions = currentWorkflow.nodes.map(n => `<option value="${n.id}">${n.id}</option>`).join('');
            const fromSelect = document.getElementById('edge-from');
            const toSelect = document.getElementById('edge-to');

            if (fromSelect.innerHTML !== nodeOptions) {
                const currentVal = fromSelect.value;
                fromSelect.innerHTML = nodeOptions;
                if (currentVal) fromSelect.value = currentVal; // Try to restore
            }
            if (toSelect.innerHTML !== nodeOptions) {
                const currentVal = toSelect.value;
                toSelect.innerHTML = nodeOptions;
                if (currentVal) toSelect.value = currentVal;
            }
        }

        // --- Selection & Editing Logic ---
        function selectNode(id) {
            console.log(`[Editor] Selecting Node: ${id}`);
            selectedNodeId = id;
            selectedEdgeIndex = null;

            if (!document.getElementById('tab-nodes').classList.contains('active')) {
                document.querySelector('.editor-tab-btn[data-tab="nodes"]').click();
            }

            document.getElementById('edge-editor').classList.add('hidden');
            const node = currentWorkflow.nodes.find(n => n.id === id);
            if (!node) return;

            const form = document.getElementById('node-editor');
            form.classList.remove('hidden');

            document.getElementById('node-id').value = node.id;
            document.getElementById('node-label').value = node.label || '';
            document.getElementById('node-type').value = node.type || 'process';

            // Show/Hide specific fields
            updateNodeFormFields(node.type);

            if (node.toolName) document.getElementById('node-tool-name').value = node.toolName;
            if (node.outcome) document.getElementById('node-outcome').value = node.outcome;

            renderEditorLists();
        }

        function selectEdge(index) {
            console.log(`[Editor] Selecting Edge Index: ${index}`);
            selectedEdgeIndex = index;
            selectedNodeId = null;

            if (!document.getElementById('tab-edges').classList.contains('active')) {
                document.querySelector('.editor-tab-btn[data-tab="edges"]').click();
            }

            document.getElementById('node-editor').classList.add('hidden');
            const edge = currentWorkflow.edges[index];
            if (!edge) return;

            // 1. Render lists FIRST to ensure dropdown options exist
            renderEditorLists();

            // 2. Then show form and set values
            const form = document.getElementById('edge-editor');
            form.classList.remove('hidden');

            document.getElementById('edge-from').value = edge.from;
            document.getElementById('edge-to').value = edge.to;
            document.getElementById('edge-label').value = edge.label || '';
        }

        function setupEditors() {
            // Node Inputs
            const updateNode = () => {
                if (!selectedNodeId) return;
                const node = currentWorkflow.nodes.find(n => n.id === selectedNodeId);
                if (!node) return;

                node.label = document.getElementById('node-label').value;
                node.type = document.getElementById('node-type').value;

                updateNodeFormFields(node.type);

                if (node.type === 'tool') node.toolName = document.getElementById('node-tool-name').value;
                else delete node.toolName;

                if (node.type === 'end') node.outcome = document.getElementById('node-outcome').value;
                else delete node.outcome;

                renderEditorLists(); renderGraph();
            };

            ['node-label', 'node-type', 'node-tool-name', 'node-outcome'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateNode);
            });

            // Add Node
            document.getElementById('add-node-btn').addEventListener('click', () => {
                const newId = 'node_' + Math.floor(Math.random() * 1000);
                currentWorkflow.nodes.push({ id: newId, label: 'New Node', type: 'process' });
                selectNode(newId);
                renderGraph();
            });

            // Delete Node
            document.getElementById('delete-node-btn').addEventListener('click', () => {
                if (!selectedNodeId) return;
                if (!confirm(`Delete node ${selectedNodeId}?`)) return;

                currentWorkflow.nodes = currentWorkflow.nodes.filter(n => n.id !== selectedNodeId);
                currentWorkflow.edges = currentWorkflow.edges.filter(e => e.from !== selectedNodeId && e.to !== selectedNodeId);

                selectedNodeId = null;
                document.getElementById('node-editor').classList.add('hidden');
                renderEditorLists();
                renderGraph();
            });

            // Edge Inputs
            const updateEdge = () => {
                if (selectedEdgeIndex === null) return;
                const edge = currentWorkflow.edges[selectedEdgeIndex];
                edge.from = document.getElementById('edge-from').value;
                edge.to = document.getElementById('edge-to').value;
                edge.label = document.getElementById('edge-label').value;
                renderEditorLists(); renderGraph();
            };

            ['edge-from', 'edge-to', 'edge-label'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateEdge);
            });

            // Add Edge
            document.getElementById('add-edge-btn').addEventListener('click', () => {
                if (currentWorkflow.nodes.length < 2) return alert("Need at least 2 nodes");
                const from = currentWorkflow.nodes[0].id;
                const to = currentWorkflow.nodes[1].id;
                currentWorkflow.edges.push({ from, to, label: '' });
                selectEdge(currentWorkflow.edges.length - 1);
                renderGraph();
            });
            // Delete Edge
            document.getElementById('delete-edge-btn').addEventListener('click', () => {
                if (selectedEdgeIndex === null) return;
                currentWorkflow.edges.splice(selectedEdgeIndex, 1);
                selectedEdgeIndex = null;
                document.getElementById('edge-editor').classList.add('hidden');
                renderEditorLists(); renderGraph();
            });

            // Rename Node (New Logic)
            document.getElementById('node-id').addEventListener('change', (e) => {
                const newId = e.target.value.trim();
                if (!selectedNodeId || !newId) return;

                if (newId === selectedNodeId) return; // No change

                // Validation: Check uniqueness
                if (currentWorkflow.nodes.find(n => n.id === newId)) {
                    alert(`ID "${newId}" already exists. Please choose a unique ID.`);
                    e.target.value = selectedNodeId; // Revert
                    return;
                }

                // 1. Update Node ID
                const node = currentWorkflow.nodes.find(n => n.id === selectedNodeId);
                node.id = newId;

                // 2. Cascade Update to Edges
                currentWorkflow.edges.forEach(edge => {
                    if (edge.from === selectedNodeId) edge.from = newId;
                    if (edge.to === selectedNodeId) edge.to = newId;
                });

                // 3. Update Selection State
                console.log(`[Editor] Renamed Node: ${selectedNodeId} -> ${newId}`);
                selectedNodeId = newId;

                // 4. Re-render
                renderEditorLists();
                renderGraph();
            });
        }

        function updateNodeFormFields(type) {
            if (type === 'tool') document.getElementById('node-tool-config').classList.remove('hidden');
            else document.getElementById('node-tool-config').classList.add('hidden');

            if (type === 'end') document.getElementById('node-outcome-config').classList.remove('hidden');
            else document.getElementById('node-outcome-config').classList.add('hidden');
        }

        function setupPanZoom() {
            const container = document.getElementById('graph-container');
            const graph = document.getElementById('mermaid-graph');
            let isDragging = false, startX, startY;

            function updateTransform() {
                graph.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
            }

            container.addEventListener('mousedown', e => { isDragging = true; startX = e.clientX - panX; startY = e.clientY - panY; container.style.cursor = 'grabbing'; });
            window.addEventListener('mousemove', e => { if (!isDragging) return; panX = e.clientX - startX; panY = e.clientY - startY; updateTransform(); });
            window.addEventListener('mouseup', () => { isDragging = false; container.style.cursor = 'grab'; });
            container.addEventListener('wheel', e => {
                e.preventDefault();
                currentZoom += e.deltaY * -0.001;
                currentZoom = Math.min(Math.max(0.2, currentZoom), 10);
                document.getElementById('zoom-display').textContent = Math.round(currentZoom * 100) + '%';
                updateTransform();
            });

            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                currentZoom = Math.min(currentZoom + 0.1, 10);
                document.getElementById('zoom-display').textContent = Math.round(currentZoom * 100) + '%';
                updateTransform();
            });

            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                currentZoom = Math.max(currentZoom - 0.1, 0.2);
                document.getElementById('zoom-display').textContent = Math.round(currentZoom * 100) + '%';
                updateTransform();
            });

            document.getElementById('preview-fit-btn').addEventListener('click', () => {
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;

                // Get natural dimensions by un-applying current zoom
                const rect = graph.getBoundingClientRect();
                // Check if rect has valid dimensions (might be 0 if hidden/empty)
                if (rect.width === 0 || rect.height === 0) return;

                const naturalWidth = rect.width / currentZoom;
                const naturalHeight = rect.height / currentZoom;

                const padding = 40;
                const availableWidth = containerWidth - padding;
                const availableHeight = containerHeight - padding;

                // Calculate scales
                const scaleX = availableWidth / naturalWidth;
                const scaleY = availableHeight / naturalHeight;

                // Fit to smallest scale to ensure full visibility
                let newZoom = Math.min(scaleX, scaleY);
                newZoom = Math.min(Math.max(0.2, newZoom), 10); // Clamp

                // Center
                panX = (containerWidth - naturalWidth * newZoom) / 2;
                panY = (containerHeight - naturalHeight * newZoom) / 2;
                currentZoom = newZoom;

                updateTransform();
                document.getElementById('zoom-display').textContent = Math.round(currentZoom * 100) + '%';
            });
        }

        function showError(msg) {
            const el = document.getElementById('error-toast');
            el.textContent = msg;
            el.classList.remove('hidden');
            el.style.display = 'flex'; // Ensure flex display for toast class
            setTimeout(() => { el.classList.add('hidden'); el.style.display = 'none'; }, 5000);
        }

        function showSuccess() {
            const el = document.getElementById('success-toast');
            el.classList.remove('hidden');
            el.style.display = 'flex';
            setTimeout(() => { el.classList.add('hidden'); el.style.display = 'none'; }, 2000);
        }
    </script>
</body>

</html>