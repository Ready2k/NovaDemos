<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Workflow Visualizer - Voice S2S</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            flowchart: { curve: 'basis' }
        });
        window.mermaid = mermaid;
    </script>
    <link rel="stylesheet" href="index.css">
    <style>
        body {
            background-color: #111827;
            color: #e5e7eb;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        /* Custom scrollbar for large diagrams */
        #graph-container {
            overflow: auto;
            max-height: 80vh;
            border: 1px solid #374151;
            background: #1f2937;
            border-radius: 8px;
            padding: 20px;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-md">
        <div class="flex items-center space-x-4">
            <a href="/" class="text-gray-400 hover:text-white transition-colors">‚Üê Back to Agent</a>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-400">
                Workflow Visualizer
            </h1>
        </div>
        <div class="flex space-x-2">
            <span class="text-xs text-gray-500 uppercase tracking-wide self-center mr-2">Experience Definition</span>
            <select id="persona-select"
                class="px-2 py-1 bg-gray-700 rounded text-xs text-gray-300 border-none outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer">
                <option value="persona-BankingDisputes">Banking Disputes Analysis</option>
                <option value="loading" disabled>Loading available personas...</option>
            </select>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto p-4 flex flex-col items-center">

        <div class="w-full max-w-6xl mb-4 flex justify-between items-center">
            <h2 class="text-lg font-bold text-white">Live Experience Graph</h2>
            <div class="flex space-x-2 bg-gray-800 p-1 rounded border border-gray-700">
                <button id="zoom-out-btn" class="px-2 py-1 hover:bg-gray-700 rounded text-gray-300 transition-colors"
                    title="Zoom Out">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                </button>
                <span id="zoom-display"
                    class="px-2 py-1 text-sm text-gray-400 font-mono w-16 text-center select-none">100%</span>
                <button id="zoom-in-btn" class="px-2 py-1 hover:bg-gray-700 rounded text-gray-300 transition-colors"
                    title="Zoom In">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </button>
                <button id="zoom-reset-btn"
                    class="px-3 py-1 hover:bg-gray-700 rounded text-gray-300 text-sm transition-colors border-l border-gray-700 ml-1">
                    Reset
                </button>
            </div>
            <button id="refresh-btn"
                class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm text-white transition-colors ml-4 shadow-lg">Refresh
                Graph</button>
        </div>

        <div id="graph-container" class="w-full max-w-6xl shadow-xl">
            <div id="loading" class="text-center text-gray-400 p-10">Loading workflow definition...</div>
            <div id="mermaid-graph" class="mermaid"></div>
        </div>

        <div class="w-full max-w-6xl mt-4 grid grid-cols-3 gap-4 text-xs text-gray-400">
            <div class="bg-gray-800 p-3 rounded">
                <span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-2"></span> Process/Start
            </div>
            <div class="bg-gray-800 p-3 rounded">
                <span class="inline-block w-3 h-3 rotate-45 bg-yellow-600 mr-2"></span> Decision Point
            </div>
            <div class="bg-gray-800 p-3 rounded">
                <span class="inline-block w-3 h-3 rounded border border-purple-400 mr-2"></span> Tool Call / Handoff
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadPersonas();

            // Event Listeners
            document.getElementById('refresh-btn').addEventListener('click', loadWorkflow);
            document.getElementById('persona-select').addEventListener('change', loadWorkflow);

            // Zoom & Pan State
            let currentZoom = 1;
            let panX = 0;
            let panY = 0;
            let isDragging = false;
            let startX = 0;
            let startY = 0;

            const zoomStep = 0.2;
            const minZoom = 0.4;
            const maxZoom = 2.0;

            const graphContainer = document.getElementById('graph-container');
            const graph = document.getElementById('mermaid-graph');

            // Set initial cursor
            graphContainer.style.cursor = 'grab';
            graphContainer.style.overflow = 'hidden'; // Hide scrollbars for custom pan

            function updateTransform() {
                if (graph) {
                    graph.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
                    graph.style.transformOrigin = 'center center'; // Changed to center for better UX
                    graph.style.transition = isDragging ? 'none' : 'transform 0.1s ease-out';

                    document.getElementById('zoom-display').textContent = `${Math.round(currentZoom * 100)}%`;
                }
            }

            // Zoom Controls
            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                if (currentZoom < maxZoom) {
                    currentZoom += zoomStep;
                    updateTransform();
                }
            });

            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                if (currentZoom > minZoom) {
                    currentZoom -= zoomStep;
                    updateTransform();
                }
            });

            document.getElementById('zoom-reset-btn').addEventListener('click', () => {
                currentZoom = 1;
                panX = 0;
                panY = 0;
                updateTransform();
            });

            // Panning Logic
            graphContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX - panX;
                startY = e.clientY - panY;
                graphContainer.style.cursor = 'grabbing';
            });

            graphContainer.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                panX = e.clientX - startX;
                panY = e.clientY - startY;
                updateTransform();
            });

            graphContainer.addEventListener('mouseup', () => {
                isDragging = false;
                graphContainer.style.cursor = 'grab';
            });

            graphContainer.addEventListener('mouseleave', () => {
                isDragging = false;
                graphContainer.style.cursor = 'grab';
            });
        });

        async function loadPersonas() {
            try {
                const response = await fetch('/api/personas');
                if (!response.ok) throw new Error('Failed to load personas');

                const personas = await response.json();
                const select = document.getElementById('persona-select');
                select.innerHTML = '';

                personas.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    // Default to banking disputes if available
                    if (p.id === 'persona-BankingDisputes') option.selected = true;
                    select.appendChild(option);
                });

                // Load initial workflow
                loadWorkflow();

            } catch (e) {
                console.error('Failed to list personas:', e);
                const select = document.getElementById('persona-select');
                select.innerHTML = '<option disabled>Error loading personas</option>';
            }
        }

        async function loadWorkflow() {
            const container = document.getElementById('mermaid-graph');
            const loading = document.getElementById('loading');
            const personaId = document.getElementById('persona-select').value;

            container.innerHTML = '';
            loading.style.display = 'block';

            try {
                const response = await fetch(`/api/workflow/${personaId}`);
                if (!response.ok) throw new Error(`Failed to load workflow config for ${personaId}`);

                const data = await response.json();
                const mermaidDef = generateMermaid(data);

                console.log('Mermaid Definition:', mermaidDef); // Debugging

                loading.style.display = 'none';

                // Clear previous error
                container.innerHTML = '';

                // Render
                const { svg } = await window.mermaid.render('graphDiv', mermaidDef);
                container.innerHTML = svg;

            } catch (e) {
                console.error('Mermaid Render Error:', e);
                loading.style.display = 'block'; // Keep loading/error visible
                loading.innerHTML = `
                    <div class="bg-red-900/50 p-4 rounded border border-red-500 text-left">
                        <h3 class="font-bold text-red-300 mb-2">Rendering Error</h3>
                        <p class="text-red-200 mb-4">${e.message}</p>
                        <details class="text-xs text-gray-400">
                            <summary>Raw Error Details</summary>
                            <pre class="mt-2 overflow-auto max-h-40">${e.stack}</pre>
                        </details>
                    </div>
                `;
            }
        }

        function generateMermaid(data) {
            let def = 'flowchart TD\n';

            // Define Nodes
            data.nodes.forEach(node => {
                // Sanitize: 
                // 1. Replace double quotes with single quotes
                // 2. Replace actual newlines with <br> tag (Mermaid allows html labels)
                const safeLabel = node.label
                    .replace(/"/g, "'")
                    .replace(/\n/g, '<br>');

                let shapeStart = '[', shapeEnd = ']';
                let styleClass = '';

                // Shapes based on type
                if (node.type === 'start' || node.type === 'end') {
                    shapeStart = '(['; shapeEnd = '])';
                    styleClass = 'fill:#1f2937,stroke:#3b82f6,stroke-width:2px,color:#fff';
                } else if (node.type === 'decision') {
                    shapeStart = '{'; shapeEnd = '}';
                    styleClass = 'fill:#374151,stroke:#f59e0b,stroke-width:2px,color:#fff';
                } else if (node.type === 'tool') {
                    shapeStart = '[['; shapeEnd = ']]';
                    styleClass = 'fill:#111827,stroke:#8b5cf6,stroke-width:2px,color:#fff';
                } else {
                    styleClass = 'fill:#1f2937,stroke:#4b5563,color:#9ca3af';
                }

                // Use quote for label
                def += `    ${node.id}${shapeStart}"${safeLabel}"${shapeEnd}\n`;
                def += `    style ${node.id} ${styleClass} \n`;
            });

            // Define Edges
            data.edges.forEach(edge => {
                // Sanitize edge label: remove quotes, replace newlines
                let label = '';
                if (edge.label) {
                    const safeEdgeLabel = edge.label.replace(/"/g, "'").replace(/\n/g, ' ');
                    label = `|"${safeEdgeLabel}"|`;
                }
                def += `    ${edge.from} -->${label} ${edge.to}\n`;
            });

            return def;
        }
    </script>
</body>

</html>