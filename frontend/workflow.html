<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Workflow Visualizer - Voice S2S</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            flowchart: { curve: 'basis' }
        });
        window.mermaid = mermaid;
    </script>
    <link rel="stylesheet" href="index.css">
    <style>
        /* Sidebar Legend Styes */
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #cbd5e1;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* Mermaid Overrides */
        .mermaid {
            display: flex;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .workspace-header {
            padding: 20px 30px;
            border-bottom: var(--glass-border);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .graph-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-top: 20px;
            border: var(--glass-border);
        }
    </style>
</head>

<body>
    <div class="app-container">

        <!-- SIDEBAR: Controls & Legend -->
        <div class="sidebar">
            <h2>View Settings</h2>

            <div class="input-group">
                <label for="persona-select">Experience Context</label>
                <select id="persona-select">
                    <option value="persona-BankingDisputes">Banking Disputes Analysis</option>
                    <option value="loading" disabled>Loading...</option>
                </select>
            </div>

            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

            <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--accent-color);">Legend</h4>
            <div class="legend-item">
                <span class="legend-color" style="background:#3b82f6;"></span> Process / Start
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:#f59e0b;"></span> Decision Point
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background:#8b5cf6;"></span> Tool Call
            </div>

            <div class="sidebar-actions">
                <button id="refresh-btn" class="secondary-btn" style="width: 100%; justify-content: center;">
                    üîÑ Refresh Graph
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT: Visualizer -->
        <div class="main-content" style="padding: 0; display: flex; flex-direction: column;">

            <div class="workspace-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="/" class="secondary-btn" style="padding: 8px 16px; font-size: 0.9rem;">
                        ‚Üê Back
                    </a>
                    <h1 style="font-size: 1.5rem; margin: 0;">Workflow Visualizer</h1>
                </div>
            </div>

            <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Graph Toolbar -->
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size: 1.2rem; margin: 0; color: white;">Live Experience Graph</h2>

                    <div
                        style="display: flex; gap: 5px; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 8px; border: var(--glass-border);">
                        <button id="zoom-out-btn" class="icon-btn"
                            style="width: 32px; height: 32px; background: transparent;">-</button>
                        <span id="zoom-display"
                            style="padding: 0 10px; color: #cbd5e1; font-family: monospace; display: flex; align-items: center; font-size: 0.9rem;">100%</span>
                        <button id="zoom-in-btn" class="icon-btn"
                            style="width: 32px; height: 32px; background: transparent;">+</button>
                        <button id="zoom-reset-btn" class="secondary-btn"
                            style="padding: 4px 12px; font-size: 0.8rem; height: 32px;">Reset</button>
                    </div>
                </div>

                <!-- Graph Container -->
                <div id="graph-container" class="graph-wrapper cursor-grab active:cursor-grabbing">
                    <div id="loading"
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b;">
                        Loading...</div>
                    <div id="mermaid-graph" class="mermaid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadPersonas();

            // Event Listeners
            document.getElementById('refresh-btn').addEventListener('click', loadWorkflow);
            document.getElementById('persona-select').addEventListener('change', loadWorkflow);

            // Zoom & Pan State
            let currentZoom = 1;
            let panX = 0;
            let panY = 0;
            let isDragging = false;
            let startX = 0;
            let startY = 0;

            const zoomStep = 0.2;
            const minZoom = 0.4;
            const maxZoom = 2.0;

            const graphContainer = document.getElementById('graph-container');
            const graph = document.getElementById('mermaid-graph');

            // Set initial cursor
            graphContainer.style.overflow = 'hidden';

            function updateTransform() {
                if (graph) {
                    graph.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
                    graph.style.transformOrigin = 'center center';
                    graph.style.transition = isDragging ? 'none' : 'transform 0.1s ease-out';
                    document.getElementById('zoom-display').textContent = `${Math.round(currentZoom * 100)}%`;
                }
            }

            // Zoom Controls
            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                if (currentZoom < maxZoom) {
                    currentZoom += zoomStep;
                    updateTransform();
                }
            });

            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                if (currentZoom > minZoom) {
                    currentZoom -= zoomStep;
                    updateTransform();
                }
            });

            document.getElementById('zoom-reset-btn').addEventListener('click', () => {
                currentZoom = 1;
                panX = 0;
                panY = 0;
                updateTransform();
            });

            // Panning Logic
            graphContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX - panX;
                startY = e.clientY - panY;
                graphContainer.style.cursor = 'grabbing';
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                panX = e.clientX - startX;
                panY = e.clientY - startY;
                updateTransform();
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
                graphContainer.style.cursor = 'grab';
            });

            container.addEventListener('wheel', e => {
                e.preventDefault();
                currentZoom += e.deltaY * -0.001;
                currentZoom = Math.min(Math.max(0.2, currentZoom), 3);
                updateTransform();
            });
        });

        async function loadPersonas() {
            try {
                const response = await fetch('/api/personas');
                if (!response.ok) throw new Error('Failed to load personas');

                const personas = await response.json();
                const select = document.getElementById('persona-select');
                select.innerHTML = '';

                personas.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    // Default to banking disputes if available
                    if (p.id === 'persona-BankingDisputes') option.selected = true;
                    select.appendChild(option);
                });

                // Load initial workflow
                loadWorkflow();

            } catch (e) {
                console.error('Failed to list personas:', e);
                const select = document.getElementById('persona-select');
                select.innerHTML = '<option disabled>Error loading personas</option>';
            }
        }

        async function loadWorkflow() {
            const container = document.getElementById('mermaid-graph');
            const loading = document.getElementById('loading');
            const personaId = document.getElementById('persona-select').value;

            container.innerHTML = '';
            loading.style.display = 'block';

            try {
                const response = await fetch(`/api/workflow/${personaId}`);
                if (!response.ok) throw new Error(`Failed to load workflow config for ${personaId}`);

                const data = await response.json();
                const mermaidDef = generateMermaid(data);

                loading.style.display = 'none';
                container.innerHTML = '';

                const { svg } = await window.mermaid.render('graphDiv', mermaidDef);
                container.innerHTML = svg;

            } catch (e) {
                console.error('Mermaid Render Error:', e);
                loading.style.display = 'block';
                loading.innerHTML = `<span style="color: #ef4444;">Error: ${e.message}</span>`;
            }
        }

        function generateMermaid(data) {
            let def = 'flowchart TD\n';

            // Define Nodes
            data.nodes.forEach(node => {
                const safeLabel = node.label.replace(/"/g, "'").replace(/\n/g, '<br>');
                let shapeStart = '[', shapeEnd = ']';
                let styleClass = '';

                if (node.type === 'start' || node.type === 'end') {
                    shapeStart = '(['; shapeEnd = '])';
                    styleClass = 'fill:#1f2937,stroke:#3b82f6,stroke-width:2px,color:#fff';
                } else if (node.type === 'decision') {
                    shapeStart = '{'; shapeEnd = '}';
                    styleClass = 'fill:#374151,stroke:#f59e0b,stroke-width:2px,color:#fff';
                } else if (node.type === 'tool') {
                    shapeStart = '[['; shapeEnd = ']]';
                    styleClass = 'fill:#111827,stroke:#8b5cf6,stroke-width:2px,color:#fff';
                } else {
                    styleClass = 'fill:#1f2937,stroke:#4b5563,color:#9ca3af';
                }

                def += `    ${node.id}${shapeStart}"${safeLabel}"${shapeEnd}\n`;
                def += `    style ${node.id} ${styleClass} \n`;
            });

            // Define Edges
            data.edges.forEach(edge => {
                let label = '';
                if (edge.label) {
                    const safeEdgeLabel = edge.label.replace(/"/g, "'").replace(/\n/g, ' ');
                    label = `|"${safeEdgeLabel}"|`;
                }
                def += `    ${edge.from} -->${label} ${edge.to}\n`;
            });

            return def;
        }
    </script>
</body>

</html>