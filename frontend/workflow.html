<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Workflow Visualizer - Voice S2S</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            flowchart: { curve: 'basis' }
        });
        window.mermaid = mermaid;
    </script>
    <link rel="stylesheet" href="index.css">
    <style>
        /* Sidebar Legend Styes */
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #cbd5e1;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }

        /* Mermaid Overrides */
        .mermaid {
            display: flex;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .workspace-header {
            padding: 20px 30px;
            border-bottom: var(--glass-border);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .graph-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-top: 20px;
            border: var(--glass-border);
        }
    </style>
</head>

<body>
    <div class="app-container">

        <!-- SIDEBAR: Controls & Legend -->
        <div class="sidebar">
            <div class="sidebar-content">
                <h2>View Settings</h2>

                <div class="input-group">
                    <label for="workflow-select">Select Workflow</label>
                    <select id="workflow-select"
                        style="width: 100%; padding: 8px; background: rgba(0,0,0,0.3); color: white; border: var(--glass-border); border-radius: 6px;">
                        <option value="loading" disabled>Loading...</option>
                    </select>
                </div>

                <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

                <h4 style="margin: 0 0 10px 0; font-size: 0.9rem; color: var(--accent-color);">Legend</h4>
                <div class="legend-item">
                    <span class="legend-color" style="background:#3b82f6;"></span> Process / Start
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background:#f59e0b;"></span> Decision Point
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background:#8b5cf6;"></span> Tool Call
                </div>

                <div class="sidebar-actions">
                    <button id="refresh-btn" class="secondary-btn" style="width: 100%; justify-content: center;">
                        üîÑ Refresh Graph
                    </button>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT: Visualizer -->
        <div class="main-content" style="padding: 0; display: flex; flex-direction: column;">

            <div class="workspace-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="/" class="secondary-btn" style="padding: 8px 16px; font-size: 0.9rem;">
                        ‚Üê Back
                    </a>
                    <h1 style="font-size: 1.5rem; margin: 0;">Workflow Visualizer</h1>
                </div>
            </div>

            <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden;">
                <!-- Graph Toolbar -->
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size: 1.2rem; margin: 0; color: white;">Live Experience Graph</h2>

                    <div
                        style="display: flex; gap: 5px; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 8px; border: var(--glass-border);">
                        <button id="zoom-out-btn" class="icon-btn"
                            style="width: 32px; height: 32px; background: transparent;">-</button>
                        <span id="zoom-display"
                            style="padding: 0 10px; color: #cbd5e1; font-family: monospace; display: flex; align-items: center; font-size: 0.9rem;">100%</span>
                        <button id="zoom-in-btn" class="icon-btn"
                            style="width: 32px; height: 32px; background: transparent;">+</button>
                        <button id="zoom-reset-btn" class="secondary-btn"
                            style="padding: 4px 12px; font-size: 0.8rem; height: 32px;">Reset</button>
                    </div>
                </div>

                <!-- Graph Container -->
                <div id="graph-container" class="graph-wrapper cursor-grab active:cursor-grabbing">
                    <div id="loading"
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #64748b;">
                        Loading...</div>
                    <div id="mermaid-graph" class="mermaid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Status Overlay -->
    <div id="live-status-panel"
        style="position: absolute; top: 100px; right: 30px; width: 280px; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; display: none; backdrop-filter: blur(10px); box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 1rem; color: white;">‚ö° Live Status</h3>
            <span id="live-indicator"
                style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e;"></span>
        </div>

        <div style="margin-bottom: 15px;">
            <div
                style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">
                Current Step</div>
            <div id="current-step-name" style="font-size: 1.1rem; color: #cbd5e1; font-weight: 600;">Waiting...</div>
        </div>

        <div id="requirements-section" style="display: none;">
            <div
                style="font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">
                Requirements</div>
            <div id="requirements-list" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Items: Account Number ‚úÖ, etc -->
            </div>
        </div>
    </div>
    </div>

    <script>
        // --- LIVE WEBSOCKET LOGIC ---
        let socket;
        function connectLive() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}`);

            socket.onopen = () => {
                console.log('[Visualizer] Connected to Live Session');
                document.getElementById('live-status-panel').style.display = 'block';
            };

            socket.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);

                    if (msg.type === 'workflow_update') {
                        handleWorkflowUpdate(msg);
                    }
                } catch (e) {
                    console.error('[Visualizer] Message error', e);
                }
            };

            socket.onclose = () => {
                console.log('[Visualizer] Disconnected');
                setTimeout(connectLive, 3000);
            };
        }

        function handleWorkflowUpdate(data) {
            const { activeNodeId, context } = data;

            // 1. Highlight Node in Graph
            highlightNode(activeNodeId);

            // 2. Update Status Panel
            document.getElementById('current-step-name').innerText = activeNodeId;
            document.getElementById('current-step-name').style.color = '#3b82f6'; // Active Blue

            // 3. Check Requirements
            updateRequirements(activeNodeId, context.extractedKeys || []);
        }

        // Global map of workflow nodes (populated during render)
        let workflowNodesData = {};

        function updateRequirements(nodeId, foundKeys) {
            const node = workflowNodesData[nodeId];
            const list = document.getElementById('requirements-list');
            const section = document.getElementById('requirements-section');
            list.innerHTML = '';

            if (node && node.required_context && node.required_context.length > 0) {
                section.style.display = 'block';

                node.required_context.forEach(key => {
                    const isFound = foundKeys.includes(key);
                    const icon = isFound ? '‚úÖ' : '‚ùå'; // Green Check or Red X
                    const color = isFound ? '#22c55e' : '#ef4444';
                    const label = key.replace(/([A-Z])/g, ' $1').trim(); // camelCase to Normal

                    const item = document.createElement('div');
                    item.style.cssText = `display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; border-left: 3px solid ${color};`;
                    item.innerHTML = `
                        <span style="font-size: 0.9rem; color: #e2e8f0;">${label}</span>
                        <span style="font-size: 1.2rem;">${icon}</span>
                    `;
                    list.appendChild(item);
                });
            } else {
                section.style.display = 'none';
            }
        }

        function highlightNode(nodeId) {
            // Reset previous styles (naive reset)
            // Ideally we iterate known nodes. For now we rely on Mermaid's class manipulation capabilities if accessible
            // Actually, manipulating SVG DOM directly is easier.
            const allNodes = document.querySelectorAll('.node');
            allNodes.forEach(n => {
                n.querySelector('rect, circle, polygon, path').style.stroke = '';
                n.querySelector('rect, circle, polygon, path').style.strokeWidth = '';
            });

            // Find active node by ID text (Mermaid puts ID in data-id or similar)
            // Mermaid 10+ uses complex IDs. We often look for the text label or matching ID attr.
            // We'll try to find the element with [id^="flowchart-${nodeId}-"]
            const activeEl = document.querySelector(`[id*="${nodeId}"]`); // Loose match
            if (activeEl) {
                const shape = activeEl.querySelector('rect, circle, polygon, path');
                if (shape) {
                    shape.style.stroke = '#22c55e'; // Green highlight
                    shape.style.strokeWidth = '4px';
                    shape.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        connectLive();
        // -----------------------------
        document.addEventListener('DOMContentLoaded', () => {
            loadWorkflows();

            // Event Listeners
            document.getElementById('refresh-btn').addEventListener('click', () => loadWorkflow(document.getElementById('workflow-select').value));
            document.getElementById('workflow-select').addEventListener('change', (e) => loadWorkflow(e.target.value));

            // Zoom & Pan State
            let currentZoom = 1;
            let panX = 0;
            let panY = 0;
            let isDragging = false;
            let startX = 0;
            let startY = 0;

            const zoomStep = 0.2;
            const minZoom = 0.4;
            const maxZoom = 5.0;

            const graphContainer = document.getElementById('graph-container');
            const graph = document.getElementById('mermaid-graph');

            // Set initial cursor
            graphContainer.style.overflow = 'hidden';

            function updateTransform() {
                if (graph) {
                    graph.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
                    graph.style.transformOrigin = 'center center';
                    graph.style.transition = isDragging ? 'none' : 'transform 0.1s ease-out';
                    document.getElementById('zoom-display').textContent = `${Math.round(currentZoom * 100)}%`;
                }
            }

            // Zoom Controls
            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                if (currentZoom < maxZoom) {
                    currentZoom += zoomStep;
                    updateTransform();
                }
            });

            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                if (currentZoom > minZoom) {
                    currentZoom -= zoomStep;
                    updateTransform();
                }
            });

            document.getElementById('zoom-reset-btn').addEventListener('click', () => {
                currentZoom = 1;
                panX = 0;
                panY = 0;
                updateTransform();
            });

            // Panning Logic
            graphContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX - panX;
                startY = e.clientY - panY;
                graphContainer.style.cursor = 'grabbing';
            });

            window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                panX = e.clientX - startX;
                panY = e.clientY - startY;
                updateTransform();
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
                graphContainer.style.cursor = 'grab';
            });

            container.addEventListener('wheel', e => {
                e.preventDefault();
                currentZoom += e.deltaY * -0.001;
                currentZoom = Math.min(Math.max(0.2, currentZoom), 5);
                updateTransform();
            });
        });

        async function loadWorkflows() {
            try {
                const response = await fetch('/api/workflows');
                if (!response.ok) throw new Error('Failed to load workflows');

                const workflows = await response.json();
                const select = document.getElementById('workflow-select');
                select.innerHTML = '';

                workflows.forEach(w => {
                    const option = document.createElement('option');
                    option.value = w.id;
                    option.textContent = w.name + (w.id === 'banking' ? ' (Default)' : '');
                    if (w.id === 'banking') option.selected = true;
                    select.appendChild(option);
                });

                if (workflows.length > 0) {
                    loadWorkflow(select.value);
                }
            } catch (e) {
                console.error('Failed to list workflows:', e);
                const select = document.getElementById('workflow-select');
                select.innerHTML = '<option disabled>Error loading workflows</option>';
            }
        }

        async function loadWorkflow(id) {
            if (!id && document.getElementById('workflow-select')) {
                id = document.getElementById('workflow-select').value;
            }

            const container = document.getElementById('mermaid-graph');
            const loading = document.getElementById('loading');

            container.innerHTML = '';
            loading.style.display = 'block';

            try {
                const response = await fetch(`/api/workflow/${id}`);
                if (!response.ok) throw new Error(`Failed to load workflow config for ${id}`);

                const data = await response.json();

                // Populate Global Node Map for Live Tracking
                workflowNodesData = {};
                if (data.nodes) {
                    data.nodes.forEach(n => {
                        workflowNodesData[n.id] = n;
                    });
                }

                const mermaidDef = generateMermaid(data);

                loading.style.display = 'none';
                container.innerHTML = '';

                const { svg } = await window.mermaid.render('graphDiv', mermaidDef);
                container.innerHTML = svg;

            } catch (e) {
                console.error('Mermaid Render Error:', e);
                loading.style.display = 'block';
                loading.innerHTML = `<span style="color: #ef4444;">Error: ${e.message}</span>`;
            }
        }

        function generateMermaid(data) {
            let def = 'flowchart TD\n';

            // Helper to escape reserved keywords & invalid chars
            const safeId = (id) => {
                const reserved = ['end', 'subgraph', 'class', 'click', 'style'];
                if (reserved.includes(id)) return id + '_safe';
                if (!id.match(/^[a-zA-Z0-9_]+$/)) return id.replace(/[^a-zA-Z0-9_]/g, '_');
                return id;
            };

            // Define Nodes
            data.nodes.forEach(node => {
                const sid = safeId(node.id);
                const labelText = (node.label && node.label.trim() !== '') ? node.label : node.id;
                const safeLabel = labelText.replace(/"/g, "'").replace(/\n/g, '<br>');
                let shapeStart = '[', shapeEnd = ']';
                let styleDef = '';

                switch (node.type) {
                    case 'start':
                    case 'end':
                        shapeStart = '(['; shapeEnd = '])';
                        styleDef = `style ${sid} fill:#1f2937,stroke:#3b82f6,stroke-width:2px,color:#fff`;
                        break;
                    case 'decision':
                        shapeStart = '{'; shapeEnd = '}';
                        styleDef = `style ${sid} fill:#374151,stroke:#f59e0b,stroke-width:2px,color:#fff`;
                        break;
                    case 'tool':
                        shapeStart = '[['; shapeEnd = ']]';
                        styleDef = `style ${sid} fill:#111827,stroke:#8b5cf6,stroke-width:2px,color:#fff`;
                        break;
                    case 'workflow':
                        shapeStart = '{{'; shapeEnd = '}}';
                        styleDef = `style ${sid} fill:#111827,stroke:#f43f5e,stroke-width:2px,color:#fff,stroke-dasharray: 5 5`;
                        break;
                    default: // process matches default
                        styleDef = `style ${sid} fill:#1f2937,stroke:#4b5563,color:#9ca3af`;
                }

                def += `    ${sid}${shapeStart}"${safeLabel}"${shapeEnd}\n`;
                def += `    ${styleDef}\n`;
            });

            // Define Edges
            data.edges.forEach(edge => {
                let label = '';
                if (edge.label) {
                    const safeEdgeLabel = edge.label.replace(/"/g, "'").replace(/\n/g, ' ');
                    label = `|"${safeEdgeLabel}"|`;
                }
                def += `    ${safeId(edge.from)} -->${label} ${safeId(edge.to)}\n`;
            });

            return def;
        }
    </script>
</body>

</html>