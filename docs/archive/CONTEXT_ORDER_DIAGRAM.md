# Context Order Fix - Visual Diagram

## The Problem

### Before Fix (Wrong Order) âŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYSTEM PROMPT (What Nova Sonic Reads)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. ### BANKING SPECIALIST - ACCOUNT SERVICES ###           â”‚
â”‚    You are a banking specialist...                         â”‚
â”‚                                                             â”‚
â”‚    **CRITICAL: CHECK THE CONTEXT ABOVE**  â† ğŸ˜• What context?â”‚
â”‚    - Customer name (already verified)                      â”‚
â”‚    - Account details (already verified)                    â”‚
â”‚    - What they originally requested                        â”‚
â”‚                                                             â”‚
â”‚    YOU MUST act on this context immediately!               â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 2. ### CURRENT SESSION CONTEXT ###         â† ğŸ”´ TOO LATE!  â”‚
â”‚    User's Original Request: balance check                  â”‚
â”‚    Customer Name: Sarah Johnson                            â”‚
â”‚    Account Number: 12345678                                â”‚
â”‚    Sort Code: 112233                                       â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 3. ### AGENT HANDOFF INSTRUCTIONS ###                      â”‚
â”‚    [Handoff tools...]                                      â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 4. ### WORKFLOW INSTRUCTIONS ###                           â”‚
â”‚    [Workflow steps...]                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: Nova Sonic reads "CHECK THE CONTEXT ABOVE" but context is below!
        Banking agent asks "How can I help you?" âŒ
```

### After Fix (Correct Order) âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SYSTEM PROMPT (What Nova Sonic Reads)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. ### CURRENT SESSION CONTEXT ###         â† ğŸŸ¢ FIRST!     â”‚
â”‚    User's Original Request: balance check                  â”‚
â”‚    Customer Name: Sarah Johnson                            â”‚
â”‚    Account Number: 12345678                                â”‚
â”‚    Sort Code: 112233                                       â”‚
â”‚                                                             â”‚
â”‚    **CRITICAL INSTRUCTION:**                               â”‚
â”‚    - Customer is already verified                          â”‚
â”‚    - User's request mentions "balance check"               â”‚
â”‚    - ACT ON IT IMMEDIATELY                                 â”‚
â”‚    - DO NOT ask "How can I help you?"                      â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 2. ### BANKING SPECIALIST - ACCOUNT SERVICES ###           â”‚
â”‚    You are a banking specialist...                         â”‚
â”‚                                                             â”‚
â”‚    **CRITICAL: LOOK AT THE SECTION ABOVE THIS** â† âœ… Found!â”‚
â”‚    It contains "CURRENT SESSION CONTEXT" with:             â”‚
â”‚    - User's Original Request (what they want)              â”‚
â”‚    - Customer Name (already verified)                      â”‚
â”‚    - Account Number (already verified)                     â”‚
â”‚    - Sort Code (already verified)                          â”‚
â”‚                                                             â”‚
â”‚    **IF YOU SEE "User's Original Request" ABOVE:**         â”‚
â”‚    - DO NOT ask "How can I help you?"                      â”‚
â”‚    - ACT IMMEDIATELY on their request                      â”‚
â”‚                                                             â”‚
â”‚    ### YOUR PROCESS ###                                    â”‚
â”‚    STEP 1: CHECK THE CONTEXT SECTION ABOVE                 â”‚
â”‚    STEP 2: IF YOU SEE "User's Original Request: balance"   â”‚
â”‚            "Hello Sarah, let me fetch your balance..."     â”‚
â”‚            [CALL: agentcore_balance]                       â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 3. ### AGENT HANDOFF INSTRUCTIONS ###                      â”‚
â”‚    [Handoff tools...]                                      â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 4. ### WORKFLOW INSTRUCTIONS ###                           â”‚
â”‚    [Workflow steps...]                                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: Nova Sonic sees context FIRST, then reads instructions!
        Banking agent acts immediately: "Hello Sarah, let me fetch your balance..." âœ…
```

## How Nova Sonic Reads the Prompt

### Before Fix âŒ

```
Nova Sonic Reading Sequence:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Read Persona Prompt                              â”‚
â”‚         "CHECK THE CONTEXT ABOVE"                        â”‚
â”‚         ğŸ˜• What context? I don't see any context above!  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: Read Context (too late)                          â”‚
â”‚         "User's Original Request: balance check"         â”‚
â”‚         ğŸ¤” Oh, there's the context... but I already      â”‚
â”‚            read the instructions that said to check it!  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3: Start Session                                    â”‚
â”‚         ğŸ’¬ "Hello Sarah, how can I help you today?"      â”‚
â”‚         âŒ Didn't act on userIntent                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After Fix âœ…

```
Nova Sonic Reading Sequence:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Read Context FIRST                               â”‚
â”‚         "User's Original Request: balance check"         â”‚
â”‚         "Customer Name: Sarah Johnson"                   â”‚
â”‚         "Account: 12345678, Sort Code: 112233"           â”‚
â”‚         âœ… Got it! User wants balance check.             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 2: Read Persona Prompt                              â”‚
â”‚         "LOOK AT THE SECTION ABOVE THIS"                 â”‚
â”‚         âœ… Yes! I see the context above!                 â”‚
â”‚         "IF YOU SEE 'User's Original Request' ABOVE:"    â”‚
â”‚         âœ… I do see it! It says "balance check"          â”‚
â”‚         "ACT IMMEDIATELY on their request"               â”‚
â”‚         âœ… Will do!                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Step 3: Start Session                                    â”‚
â”‚         ğŸ’¬ "Hello Sarah, let me fetch your balance..."   â”‚
â”‚         ğŸ”§ [Calls agentcore_balance immediately]         â”‚
â”‚         âœ… Acting on userIntent!                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Code Change

### agents/src/agent-runtime-s2s.ts

```typescript
// BEFORE (Wrong Order) âŒ
systemPrompt = `${personaPrompt}${contextInjection}${handoffInstructions}...`;
//              â†‘ Instructions  â†‘ Context (too late!)

// AFTER (Correct Order) âœ…
systemPrompt = `${contextInjection}${personaPrompt}${handoffInstructions}...`;
//              â†‘ Context FIRST!  â†‘ Instructions (can reference context above)
```

## Why This Matters

### Sequential Reading
Nova Sonic reads the system prompt **sequentially** from top to bottom:
1. First thing it sees = first thing it knows
2. Instructions that reference "above" need context to be above them
3. Context that comes after instructions is too late

### Reference Resolution
When Nova Sonic reads "CHECK THE CONTEXT ABOVE":
- âŒ If context is below: Nova Sonic doesn't know what to check
- âœ… If context is above: Nova Sonic can look up and find it

### Instruction Following
Nova Sonic follows instructions based on what it has seen:
- âŒ "Act on userIntent" but userIntent not seen yet = can't act
- âœ… "Act on userIntent" and userIntent already seen = can act immediately

## The Fix in Action

### User Journey with Correct Order

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User Request                                             â”‚
â”‚    "I want to check my balance"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Triage â†’ IDV â†’ Banking Handoff                           â”‚
â”‚    Gateway stores memory:                                   â”‚
â”‚    - userIntent: "balance check"                            â”‚
â”‚    - verified: true                                         â”‚
â”‚    - userName: "Sarah Johnson"                              â”‚
â”‚    - account: "12345678"                                    â”‚
â”‚    - sortCode: "112233"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Banking Agent Session Init                               â”‚
â”‚    Constructs system prompt in CORRECT ORDER:               â”‚
â”‚                                                             â”‚
â”‚    [CONTEXT] â† User intent + verified user                  â”‚
â”‚    [PERSONA] â† Instructions to check context above          â”‚
â”‚    [HANDOFF] â† Handoff tools                                â”‚
â”‚    [WORKFLOW] â† Workflow steps                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Nova Sonic Reads Prompt                                  â”‚
â”‚    âœ… Sees context FIRST                                    â”‚
â”‚    âœ… Sees userIntent = "balance check"                     â”‚
â”‚    âœ… Sees verified user = "Sarah Johnson"                  â”‚
â”‚    âœ… Reads instructions to act immediately                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Banking Agent Response                                   â”‚
â”‚    ğŸ’¬ "Hello Sarah, let me fetch your balance for you..."   â”‚
â”‚    ğŸ”§ [Calls agentcore_balance(12345678, 112233)]           â”‚
â”‚    ğŸ’¬ "Your current balance is Â£1,234.56"                   â”‚
â”‚    ğŸ”„ [Calls return_to_triage]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Summary

**The Problem:** Context came after instructions that referenced it  
**The Solution:** Put context BEFORE instructions  
**The Result:** Nova Sonic can see and act on context immediately  

Simple fix, big impact! ğŸ‰
